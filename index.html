<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒã‚¹ç‘æƒ³ é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #5a67d8;
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zen-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .date-info {
            color: #666;
            font-size: 14px;
        }

        .save-status {
            display: inline-block;
            margin-left: 10px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            background: #c6f6d5;
            color: #22543d;
            font-weight: bold;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            font-size: 18px;
            color: #4a5568;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .stat-number {
            font-size: 48px;
            font-weight: bold;
            color: #5a67d8;
            margin: 10px 0;
        }

        .stat-label {
            color: #718096;
            font-size: 14px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e2e8f0;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .team-member {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: #f7fafc;
            border-radius: 10px;
            transition: background 0.3s ease;
        }

        .team-member:hover {
            background: #edf2f7;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 600;
            color: #2d3748;
        }

        .member-stats {
            font-size: 12px;
            color: #718096;
        }

        .member-progress {
            width: 100px;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .member-progress-fill {
            height: 100%;
            background: #48bb78;
            transition: width 0.3s ease;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .effect-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .effect-item {
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            text-align: center;
        }

        .effect-score {
            font-size: 24px;
            font-weight: bold;
            color: #5a67d8;
            margin-bottom: 5px;
        }

        .effect-label {
            font-size: 12px;
            color: #718096;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        input, select {
            padding: 8px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 14px;
            min-width: 180px;
        }

        select {
            min-width: 150px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }

        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-warning {
            background: #fed7d7;
            color: #742a2a;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .config-notice {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }

        .config-notice strong {
            display: block;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .effect-grid {
                grid-template-columns: 1fr;
            }

            input, select {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <header>
            <h1>
                <div class="zen-icon">ğŸ§˜</div>
                ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒã‚¹ç‘æƒ³ é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
            </h1>
            <div class="date-info">
                <span id="currentDate"></span> | æ¥­å‹™æ”¹å–„ãƒãƒ¼ãƒ 
                <span class="save-status" id="saveStatus">ğŸ”„ èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
        </header>

        <!-- APIè¨­å®šã®æ³¨æ„å–šèµ· -->
        <div class="config-notice" id="configNotice" style="display: none;">
            <strong>âš ï¸ è¨­å®šãŒå¿…è¦ã§ã™</strong>
            HTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ã€ŒAPI_URLã€ã«Google Apps Scriptã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
        </div>

        <div class="control-panel">
            <h3 style="margin-bottom: 15px; color: #4a5568;">ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ãƒ»ç®¡ç†</h3>
            <div class="input-group">
                <select id="memberSelect">
                    <option value="">ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠ</option>
                    <option value="é‡æ">é‡æ</option>
                    <option value="å¯ºæ¾¤">å¯ºæ¾¤</option>
                    <option value="ä¸‹å‡º">ä¸‹å‡º</option>
                    <option value="æ±éƒ·">æ±éƒ·</option>
                    <option value="æ —ç§‹">æ —ç§‹</option>
                </select>
                <input type="number" id="sessionMinutes" placeholder="å®Ÿæ–½æ™‚é–“ï¼ˆåˆ†ï¼‰" min="1" max="60">
            </div>
            <div class="input-group">
                <input type="number" id="stressLevel" placeholder="ã‚¹ãƒˆãƒ¬ã‚¹è»½æ¸›åº¦(1-10)" min="1" max="10">
                <input type="number" id="focusLevel" placeholder="é›†ä¸­åŠ›å‘ä¸Šåº¦(1-10)" min="1" max="10">
                <input type="number" id="sleepLevel" placeholder="ç¡çœ ã®è³ª(1-10)" min="1" max="10">
                <input type="number" id="moodLevel" placeholder="æ°—åˆ†ã®å®‰å®š(1-10)" min="1" max="10">
            </div>
            <div class="button-group">
                <button onclick="addSession()" id="addButton">ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²</button>
                <button onclick="loadDataFromSheet()">ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿</button>
                <button onclick="exportData()">ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h3 class="card-title">ğŸ“Š ä»Šé€±ã®å®Ÿæ–½çŠ¶æ³</h3>
                <div class="stat-number" id="weeklyRate">0%</div>
                <div class="stat-label">ãƒãƒ¼ãƒ å…¨ä½“ã®å®Ÿæ–½ç‡</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="weeklyProgress" style="width: 0%">
                        0/25 ã‚»ãƒƒã‚·ãƒ§ãƒ³
                    </div>
                </div>
                <p style="margin-top: 10px; color: #718096; font-size: 14px;">
                    ç›®æ¨™: é€±5æ—¥ Ã— 5äºº = 25ã‚»ãƒƒã‚·ãƒ§ãƒ³
                </p>
            </div>

            <div class="card">
                <h3 class="card-title">â±ï¸ ç´¯è¨ˆå®Ÿæ–½æ™‚é–“</h3>
                <div class="stat-number" id="totalMinutes">0</div>
                <div class="stat-label">åˆ†ï¼ˆä»Šé€±ï¼‰</div>
                <div style="margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>å¹³å‡å®Ÿæ–½æ™‚é–“</span>
                        <strong id="avgMinutes">0åˆ†/å›</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>æœ€é•·è¨˜éŒ²</span>
                        <strong id="maxMinutes">0åˆ†</strong>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">ğŸ¯ æœˆé–“ç›®æ¨™é”æˆåº¦</h3>
                <div class="stat-number" id="monthlyRate">0%</div>
                <div class="stat-label">é”æˆç‡</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="monthlyProgress" style="width: 0%">
                        0/80 ã‚»ãƒƒã‚·ãƒ§ãƒ³
                    </div>
                </div>
                <p style="margin-top: 10px; color: #718096; font-size: 14px;" id="monthlyRemaining">
                    æ®‹ã‚Š: 80ã‚»ãƒƒã‚·ãƒ§ãƒ³
                </p>
            </div>

            <div class="card">
                <h3 class="card-title">âœ¨ åŠ¹æœæ¸¬å®šï¼ˆå¹³å‡å€¤ï¼‰</h3>
                <div class="effect-grid">
                    <div class="effect-item">
                        <div class="effect-score" id="stressScore">0.0</div>
                        <div class="effect-label">ã‚¹ãƒˆãƒ¬ã‚¹è»½æ¸›</div>
                    </div>
                    <div class="effect-item">
                        <div class="effect-score" id="focusScore">0.0</div>
                        <div class="effect-label">é›†ä¸­åŠ›å‘ä¸Š</div>
                    </div>
                    <div class="effect-item">
                        <div class="effect-score" id="sleepScore">0.0</div>
                        <div class="effect-label">ç¡çœ ã®è³ª</div>
                    </div>
                    <div class="effect-item">
                        <div class="effect-score" id="moodScore">0.0</div>
                        <div class="effect-label">æ°—åˆ†ã®å®‰å®š</div>
                    </div>
                </div>
            </div>

            <div class="card full-width">
                <h3 class="card-title">ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼åˆ¥é€²æ—</h3>
                <div id="teamMembersList">
                </div>
            </div>

            <div class="card full-width">
                <h3 class="card-title">ğŸ“ˆ é€±æ¬¡æ¨ç§»ã‚°ãƒ©ãƒ•</h3>
                <div class="chart-container">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>

            <div class="card full-width">
                <h3 class="card-title">ğŸ“Š åŠ¹æœæ¸¬å®šæ¨ç§»</h3>
                <div class="chart-container">
                    <canvas id="effectChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===================================
        // ğŸ”§ é‡è¦: ã“ã“ã«Google Apps Scriptã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è¨­å®šã—ã¦ãã ã•ã„
        // ===================================
        const API_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE';
        // ä¾‹: 'https://script.google.com/macros/s/AKfycbx.../exec'
        
        // API URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
            document.getElementById('configNotice').style.display = 'block';
        }

        // æ—¥ä»˜ã®è¡¨ç¤º
        function updateDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('ja-JP', options);
        }
        updateDate();

        // é€±ç•ªå·ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆ0ã‹ã‚‰å§‹ã¾ã‚‹ï¼‰
        function getCurrentWeekNumber() {
            const today = new Date();
            const month = today.getMonth() + 1;
            const weekNumber = getWeekNumber(today) - 1; // 0ãƒ™ãƒ¼ã‚¹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
            
            // 12æœˆç¬¬1é€±ã‹ã‚‰é †ã«0,1,2,3,4,5,6,7ã¨å‰²ã‚Šå½“ã¦
            if (month === 12) {
                return weekNumber;
            } else if (month === 1) {
                return 4 + weekNumber;
            }
            
            return 0; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç¬¬1é€±
        }

        // é€±ç•ªå·ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆ1ã‹ã‚‰å§‹ã¾ã‚‹ï¼‰
        function getWeekNumber(date) {
            const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
            const dayOfMonth = date.getDate();
            const firstDayWeekday = firstDayOfMonth.getDay();
            
            const weekNumber = Math.ceil((dayOfMonth + firstDayWeekday) / 7);
            
            return weekNumber;
        }

        // é€±ã®ãƒ©ãƒ™ãƒ«ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
        function generateWeekLabels() {
            return [
                '2024å¹´12æœˆç¬¬1é€±',
                '2024å¹´12æœˆç¬¬2é€±',
                '2024å¹´12æœˆç¬¬3é€±',
                '2024å¹´12æœˆç¬¬4é€±',
                '2025å¹´1æœˆç¬¬1é€±',
                '2025å¹´1æœˆç¬¬2é€±',
                '2025å¹´1æœˆç¬¬3é€±',
                '2025å¹´1æœˆç¬¬4é€±'
            ];
        }

        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”¨ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        let dashboardData = {
            members: {
                'é‡æ': { sessions: 0, minutes: 0, stressTotal: 0, focusTotal: 0, sleepTotal: 0, moodTotal: 0 },
                'å¯ºæ¾¤': { sessions: 0, minutes: 0, stressTotal: 0, focusTotal: 0, sleepTotal: 0, moodTotal: 0 },
                'ä¸‹å‡º': { sessions: 0, minutes: 0, stressTotal: 0, focusTotal: 0, sleepTotal: 0, moodTotal: 0 },
                'æ±éƒ·': { sessions: 0, minutes: 0, stressTotal: 0, focusTotal: 0, sleepTotal: 0, moodTotal: 0 },
                'æ —ç§‹': { sessions: 0, minutes: 0, stressTotal: 0, focusTotal: 0, sleepTotal: 0, moodTotal: 0 }
            },
            weeklyData: [0, 0, 0, 0, 0, 0, 0, 0],
            effectData: {
                stress: [0, 0, 0, 0, 0, 0, 0, 0],
                focus: [0, 0, 0, 0, 0, 0, 0, 0],
                sleep: [0, 0, 0, 0, 0, 0, 0, 0],
                mood: [0, 0, 0, 0, 0, 0, 0, 0]
            },
            currentWeek: getCurrentWeekNumber()
        };

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }

        // ä¿å­˜çŠ¶æ…‹ã®è¡¨ç¤º
        function showSaveStatus(text, bgColor, textColor) {
            const status = document.getElementById('saveStatus');
            status.textContent = text;
            status.style.background = bgColor;
            status.style.color = textColor;
        }

        // Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        async function loadDataFromSheet() {
            if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                alert('âš ï¸ Google Apps Scriptã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nHTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ã€ŒAPI_URLã€ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            showLoading(true);
            showSaveStatus('ğŸ”„ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...', '#bee3f8', '#2c5282');

            try {
                const response = await fetch(`${API_URL}?action=getData`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                    dashboardData.members = result.members;
                    dashboardData.weeklyData = result.weeklyData;
                    dashboardData.effectData = result.effectData;

                    // UIã‚’æ›´æ–°
                    updateDashboard();
                    updateCharts();

                    showSaveStatus('âœ… ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†', '#c6f6d5', '#22543d');
                } else {
                    throw new Error(result.error || 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showSaveStatus('âš ï¸ èª­ã¿è¾¼ã¿å¤±æ•—', '#fed7d7', '#742a2a');
                alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nè©³ç´°: ' + error.message + '\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«(F12)ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } finally {
                showLoading(false);
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½åŠ æ©Ÿèƒ½
        async function addSession() {
            const member = document.getElementById('memberSelect').value;
            const minutes = parseInt(document.getElementById('sessionMinutes').value);
            const stress = parseInt(document.getElementById('stressLevel').value) || 0;
            const focus = parseInt(document.getElementById('focusLevel').value) || 0;
            const sleep = parseInt(document.getElementById('sleepLevel').value) || 0;
            const mood = parseInt(document.getElementById('moodLevel').value) || 0;

            if (!member || !minutes) {
                alert('ãƒ¡ãƒ³ãƒãƒ¼ã¨å®Ÿæ–½æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                alert('âš ï¸ Google Apps Scriptã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nHTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ã€ŒAPI_URLã€ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const addButton = document.getElementById('addButton');
            addButton.disabled = true;
            addButton.textContent = 'ä¿å­˜ä¸­...';

            showLoading(true);
            showSaveStatus('ğŸ’¾ ä¿å­˜ä¸­...', '#bee3f8', '#2c5282');

            try {
                const sessionData = {
                    action: 'addSession',
                    member: member,
                    minutes: minutes,
                    stress: stress,
                    focus: focus,
                    sleep: sleep,
                    mood: mood,
                    weekNumber: dashboardData.currentWeek
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(sessionData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    showSaveStatus('âœ… ä¿å­˜å®Œäº†', '#c6f6d5', '#22543d');
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                    await loadDataFromSheet();
                    
                    alert(`${member}ã•ã‚“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆ${minutes}åˆ†ï¼‰ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ`);
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                    document.getElementById('memberSelect').value = '';
                    document.getElementById('sessionMinutes').value = '';
                    document.getElementById('stressLevel').value = '';
                    document.getElementById('focusLevel').value = '';
                    document.getElementById('sleepLevel').value = '';
                    document.getElementById('moodLevel').value = '';
                } else {
                    throw new Error(result.error || 'ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

            } catch (error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showSaveStatus('âš ï¸ ä¿å­˜å¤±æ•—', '#fed7d7', '#742a2a');
                alert('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nè©³ç´°: ' + error.message + '\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«(F12)ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            } finally {
                showLoading(false);
                addButton.disabled = false;
                addButton.textContent = 'ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²';
            }
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
        function updateDashboard() {
            // é€±æ¬¡å®Ÿæ–½ç‡ã®æ›´æ–°
            let totalSessions = 0;
            let totalStress = 0;
            let totalFocus = 0;
            let totalSleep = 0;
            let totalMood = 0;
            let dataCount = 0;
            
            Object.values(dashboardData.members).forEach(member => {
                totalSessions += member.sessions;
                totalStress += member.stressTotal;
                totalFocus += member.focusTotal;
                totalSleep += member.sleepTotal;
                totalMood += member.moodTotal;
                
                // ãƒ‡ãƒ¼ã‚¿æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆåˆè¨ˆå€¤ãŒ0ã‚ˆã‚Šå¤§ãã„å ´åˆï¼‰
                if (member.stressTotal > 0 || member.focusTotal > 0 || 
                    member.sleepTotal > 0 || member.moodTotal > 0) {
                    dataCount += member.sessions;
                }
            });
            
            const weeklyRate = Math.round((totalSessions / 25) * 100);
            document.getElementById('weeklyRate').textContent = weeklyRate + '%';
            document.getElementById('weeklyProgress').style.width = weeklyRate + '%';
            document.getElementById('weeklyProgress').textContent = `${totalSessions}/25 ã‚»ãƒƒã‚·ãƒ§ãƒ³`;

            // ç´¯è¨ˆæ™‚é–“ã®æ›´æ–°
            let totalMinutes = 0;
            let maxMinutes = 0;
            Object.values(dashboardData.members).forEach(member => {
                totalMinutes += member.minutes;
                if (member.minutes > maxMinutes) {
                    maxMinutes = member.minutes;
                }
            });
            document.getElementById('totalMinutes').textContent = totalMinutes;
            if (totalSessions > 0) {
                document.getElementById('avgMinutes').textContent = Math.round(totalMinutes / totalSessions) + 'åˆ†/å›';
            } else {
                document.getElementById('avgMinutes').textContent = '0åˆ†/å›';
            }
            document.getElementById('maxMinutes').textContent = maxMinutes + 'åˆ†';
            
            // æœˆé–“é”æˆåº¦ã®æ›´æ–°
            const monthlyGoal = 80;
            const monthlyRate = Math.min(Math.round((totalSessions / monthlyGoal) * 100), 100);
            const remainingSessions = Math.max(monthlyGoal - totalSessions, 0);
            
            document.getElementById('monthlyRate').textContent = monthlyRate + '%';
            document.getElementById('monthlyProgress').style.width = monthlyRate + '%';
            document.getElementById('monthlyProgress').textContent = `${totalSessions}/${monthlyGoal} ã‚»ãƒƒã‚·ãƒ§ãƒ³`;
            document.getElementById('monthlyRemaining').textContent = `æ®‹ã‚Š: ${remainingSessions}ã‚»ãƒƒã‚·ãƒ§ãƒ³`;
            
            // åŠ¹æœæ¸¬å®šã®å¹³å‡å€¤ã‚’æ›´æ–°
            if (dataCount > 0) {
                document.getElementById('stressScore').textContent = (totalStress / dataCount).toFixed(1);
                document.getElementById('focusScore').textContent = (totalFocus / dataCount).toFixed(1);
                document.getElementById('sleepScore').textContent = (totalSleep / dataCount).toFixed(1);
                document.getElementById('moodScore').textContent = (totalMood / dataCount).toFixed(1);
            } else {
                document.getElementById('stressScore').textContent = '0.0';
                document.getElementById('focusScore').textContent = '0.0';
                document.getElementById('sleepScore').textContent = '0.0';
                document.getElementById('moodScore').textContent = '0.0';
            }
            
            // ãƒ¡ãƒ³ãƒãƒ¼åˆ¥é€²æ—UIã‚’æ›´æ–°
            updateMemberDisplay();
        }
        
        // ãƒ¡ãƒ³ãƒãƒ¼åˆ¥é€²æ—ã®è¡¨ç¤ºã‚’æ›´æ–°
        function updateMemberDisplay() {
            const membersList = document.getElementById('teamMembersList');
            membersList.innerHTML = '';
            
            Object.entries(dashboardData.members).forEach(([name, data]) => {
                const progressPercent = Math.round((data.sessions / 5) * 100);
                const badge = progressPercent >= 100 ? 
                    '<span class="badge badge-success">å„ªç§€</span>' : 
                    (progressPercent < 50 ? '<span class="badge badge-warning">è¦ã‚µãƒãƒ¼ãƒˆ</span>' : '');
                
                const memberDiv = document.createElement('div');
                memberDiv.className = 'team-member';
                memberDiv.innerHTML = `
                    <div class="member-avatar">${name.charAt(0)}</div>
                    <div class="member-info">
                        <div class="member-name">
                            ${name}
                            ${badge}
                        </div>
                        <div class="member-stats">ä»Šé€±: ${data.sessions}/5å› | åˆè¨ˆ: ${data.minutes}åˆ†</div>
                    </div>
                    <div class="member-progress">
                        <div class="member-progress-fill" style="width: ${Math.min(progressPercent, 100)}%"></div>
                    </div>
                `;
                membersList.appendChild(memberDiv);
            });
        }

        // ã‚°ãƒ©ãƒ•æ›´æ–°é–¢æ•°
        function updateCharts() {
            // é€±æ¬¡æ¨ç§»ã‚°ãƒ©ãƒ•ã®æœ€å¤§å€¤ã‚’è‡ªå‹•è¨ˆç®—
            const maxWeekly = Math.max(...dashboardData.weeklyData, 25);
            weeklyChart.options.scales.y.max = Math.ceil(maxWeekly / 5) * 5 + 5;
            weeklyChart.data.datasets[0].data = dashboardData.weeklyData;
            weeklyChart.update();
            
            // åŠ¹æœæ¸¬å®šã‚°ãƒ©ãƒ•ã®æœ€å¤§å€¤ã‚’è‡ªå‹•è¨ˆç®—
            const allEffectValues = [
                ...dashboardData.effectData.stress,
                ...dashboardData.effectData.focus,
                ...dashboardData.effectData.sleep,
                ...dashboardData.effectData.mood
            ];
            const maxEffect = Math.max(...allEffectValues, 50);
            effectChart.options.scales.y.max = Math.ceil(maxEffect / 10) * 10 + 10;
            
            effectChart.data.datasets[0].data = dashboardData.effectData.stress;
            effectChart.data.datasets[1].data = dashboardData.effectData.focus;
            effectChart.data.datasets[2].data = dashboardData.effectData.sleep;
            effectChart.data.datasets[3].data = dashboardData.effectData.mood;
            effectChart.update();
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function exportData() {
            const csvContent = "data:text/csv;charset=utf-8,ãƒ¡ãƒ³ãƒãƒ¼,ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°,åˆè¨ˆæ™‚é–“ï¼ˆåˆ†ï¼‰,ã‚¹ãƒˆãƒ¬ã‚¹åˆè¨ˆ,é›†ä¸­åŠ›åˆè¨ˆ,ç¡çœ åˆè¨ˆ,æ°—åˆ†åˆè¨ˆ\n" +
                Object.entries(dashboardData.members).map(([name, data]) => 
                    `${name},${data.sessions},${data.minutes},${data.stressTotal},${data.focusTotal},${data.sleepTotal},${data.moodTotal}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `mindfulness_data_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
        }

        // é€±ã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
        const weekLabels = generateWeekLabels();

        // é€±æ¬¡æ¨ç§»ã‚°ãƒ©ãƒ•
        const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
        const weeklyChart = new Chart(weeklyCtx, {
            type: 'bar',
            data: {
                labels: weekLabels,
                datasets: [{
                    label: 'å®Ÿæ–½ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°',
                    data: dashboardData.weeklyData,
                    backgroundColor: 'rgba(102, 126, 234, 0.6)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 2,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        borderRadius: 8
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 30,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // åŠ¹æœæ¸¬å®šæ¨ç§»ã‚°ãƒ©ãƒ•
        const effectCtx = document.getElementById('effectChart').getContext('2d');
        const effectChart = new Chart(effectCtx, {
            type: 'line',
            data: {
                labels: weekLabels,
                datasets: [
                    {
                        label: 'ã‚¹ãƒˆãƒ¬ã‚¹è»½æ¸›',
                        data: dashboardData.effectData.stress,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.4
                    },
                    {
                        label: 'é›†ä¸­åŠ›å‘ä¸Š',
                        data: dashboardData.effectData.focus,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.4
                    },
                    {
                        label: 'ç¡çœ ã®è³ª',
                        data: dashboardData.effectData.sleep,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.4
                    },
                    {
                        label: 'æ°—åˆ†ã®å®‰å®š',
                        data: dashboardData.effectData.mood,
                        borderColor: 'rgba(153, 102, 255, 1)',
                        backgroundColor: 'rgba(153, 102, 255, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        borderRadius: 8
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.onload = function() {
            updateDashboard();
            updateCharts();
            
            // åˆå›ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadDataFromSheet();
        };
    </script>
</body>
</html>
