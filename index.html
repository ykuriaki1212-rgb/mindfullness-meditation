<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒã‚¹ç‘æƒ³ é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆãƒãƒ¼ãƒ å…±æœ‰ç‰ˆï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #5a67d8;
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zen-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .date-info {
            color: #666;
            font-size: 14px;
        }

        .connection-status {
            display: inline-block;
            margin-left: 10px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-connected {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-disconnected {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-loading {
            background: #fef3c7;
            color: #78350f;
        }

        .setup-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .setup-section {
            margin-bottom: 20px;
        }

        .setup-section h3 {
            color: #5a67d8;
            margin-bottom: 10px;
        }

        .setup-section p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .config-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
            margin: 5px 0;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            font-size: 18px;
            color: #4a5568;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .stat-number {
            font-size: 48px;
            font-weight: bold;
            color: #5a67d8;
            margin: 10px 0;
        }

        .stat-label {
            color: #718096;
            font-size: 14px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e2e8f0;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .team-member {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: #f7fafc;
            border-radius: 10px;
            transition: background 0.3s ease;
        }

        .team-member:hover {
            background: #edf2f7;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 600;
            color: #2d3748;
        }

        .member-stats {
            font-size: 12px;
            color: #718096;
        }

        .member-progress {
            width: 100px;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .member-progress-fill {
            height: 100%;
            background: #48bb78;
            transition: width 0.3s ease;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .effect-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .effect-item {
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            text-align: center;
        }

        .effect-score {
            font-size: 24px;
            font-weight: bold;
            color: #5a67d8;
            margin-bottom: 5px;
        }

        .effect-label {
            font-size: 12px;
            color: #718096;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        input, select {
            padding: 8px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 14px;
            min-width: 180px;
        }

        select {
            min-width: 150px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }

        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-warning {
            background: #fed7d7;
            color: #742a2a;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .effect-grid {
                grid-template-columns: 1fr;
            }

            input, select {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Firebaseè¨­å®šãƒ‘ãƒãƒ« -->
        <div class="setup-panel" id="setupPanel">
            <h2 style="color: #5a67d8; margin-bottom: 20px;">ğŸ”§ Firebase åˆæœŸè¨­å®š</h2>
            
            <div class="setup-section">
                <h3>ã‚¹ãƒ†ãƒƒãƒ—1: Firebase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ</h3>
                <p>1. <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a> ã«ã‚¢ã‚¯ã‚»ã‚¹</p>
                <p>2. ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ã€ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
                <p>3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ï¼ˆä¾‹: mindfulness-dashboardï¼‰</p>
                <p>4. Google ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã¯ä¸è¦ãªã®ã§ã‚¹ã‚­ãƒƒãƒ—å¯èƒ½</p>
            </div>

            <div class="setup-section">
                <h3>ã‚¹ãƒ†ãƒƒãƒ—2: Realtime Database ã‚’æœ‰åŠ¹åŒ–</h3>
                <p>1. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒRealtime Databaseã€ã‚’é¸æŠ</p>
                <p>2. ã€Œãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
                <p>3. ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³: asia-southeast1 (ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«) ã‚’é¸æŠ</p>
                <p>4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«: ã€Œãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§é–‹å§‹ã€ã‚’é¸æŠ</p>
            </div>

            <div class="setup-section">
                <h3>ã‚¹ãƒ†ãƒƒãƒ—3: Firebaseè¨­å®šæƒ…å ±ã‚’å–å¾—</h3>
                <p>1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šï¼ˆæ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³ï¼‰â†’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®š</p>
                <p>2. ä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã€Œã‚¢ãƒ—ãƒªã‚’è¿½åŠ ã€â†’ Webï¼ˆ</>ï¼‰ã‚’é¸æŠ</p>
                <p>3. ã‚¢ãƒ—ãƒªã®ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ï¼ˆä¾‹: mindfulness-webï¼‰</p>
                <p>4. è¡¨ç¤ºã•ã‚Œã‚‹è¨­å®šæƒ…å ±ã‚’ä»¥ä¸‹ã«å…¥åŠ›:</p>
                
                <input type="text" class="config-input" id="apiKey" placeholder="apiKey: AIza...">
                <input type="text" class="config-input" id="authDomain" placeholder="authDomain: your-project.firebaseapp.com">
                <input type="text" class="config-input" id="databaseURL" placeholder="databaseURL: https://your-project-default-rtdb.firebaseio.com">
                <input type="text" class="config-input" id="projectId" placeholder="projectId: your-project">
                
                <button onclick="saveFirebaseConfig()" style="margin-top: 15px;">âœ… è¨­å®šã‚’ä¿å­˜ã—ã¦æ¥ç¶š</button>
                <button onclick="hideSetupPanel()" style="background: #718096;">â­ï¸ å¾Œã§è¨­å®šã™ã‚‹</button>
            </div>
        </div>

        <header>
            <h1>
                <div class="zen-icon">ğŸ§˜</div>
                ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒã‚¹ç‘æƒ³ é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆãƒãƒ¼ãƒ å…±æœ‰ç‰ˆï¼‰
            </h1>
            <div class="date-info">
                <span id="currentDate"></span> | æ¥­å‹™æ”¹å–„ãƒãƒ¼ãƒ 
                <span class="connection-status status-loading" id="connectionStatus">ğŸ”Œ æ¥ç¶šæº–å‚™ä¸­...</span>
            </div>
        </header>

        <div class="control-panel">
            <h3 style="margin-bottom: 15px; color: #4a5568;">ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ãƒ»ç®¡ç†</h3>
            <div class="input-group">
                <select id="memberSelect">
                    <option value="">ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠ</option>
                    <option value="é‡æ">é‡æ</option>
                    <option value="å¯ºæ¾¤">å¯ºæ¾¤</option>
                    <option value="ä¸‹å‡º">ä¸‹å‡º</option>
                    <option value="æ±éƒ·">æ±éƒ·</option>
                    <option value="æ —ç§‹">æ —ç§‹</option>
                </select>
                <input type="number" id="sessionMinutes" placeholder="å®Ÿæ–½æ™‚é–“ï¼ˆåˆ†ï¼‰" min="1" max="60">
            </div>
            <div class="input-group">
                <input type="number" id="stressLevel" placeholder="ã‚¹ãƒˆãƒ¬ã‚¹è»½æ¸›åº¦(1-10)" min="1" max="10">
                <input type="number" id="focusLevel" placeholder="é›†ä¸­åŠ›å‘ä¸Šåº¦(1-10)" min="1" max="10">
                <input type="number" id="sleepLevel" placeholder="ç¡çœ ã®è³ª(1-10)" min="1" max="10">
                <input type="number" id="moodLevel" placeholder="æ°—åˆ†ã®å®‰å®š(1-10)" min="1" max="10">
            </div>
            <div class="button-group">
                <button onclick="addSession()" id="addSessionBtn">ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²</button>
                <button onclick="exportData()">ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <button onclick="resetWeek()">é€±æ¬¡ãƒªã‚»ãƒƒãƒˆ</button>
                <button onclick="showSetupPanel()">âš™ï¸ Firebaseè¨­å®š</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h3 class="card-title">ğŸ“Š ä»Šé€±ã®å®Ÿæ–½çŠ¶æ³</h3>
                <div class="stat-number" id="weeklyRate">0%</div>
                <div class="stat-label">ãƒãƒ¼ãƒ å…¨ä½“ã®å®Ÿæ–½ç‡</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="weeklyProgress" style="width: 0%">
                        0/25 ã‚»ãƒƒã‚·ãƒ§ãƒ³
                    </div>
                </div>
                <p style="margin-top: 10px; color: #718096; font-size: 14px;">
                    ç›®æ¨™: é€±5æ—¥ Ã— 5äºº = 25ã‚»ãƒƒã‚·ãƒ§ãƒ³
                </p>
            </div>

            <div class="card">
                <h3 class="card-title">â±ï¸ ç´¯è¨ˆå®Ÿæ–½æ™‚é–“</h3>
                <div class="stat-number" id="totalMinutes">0</div>
                <div class="stat-label">åˆ†ï¼ˆä»Šé€±ï¼‰</div>
                <div style="margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>å¹³å‡å®Ÿæ–½æ™‚é–“</span>
                        <strong id="avgMinutes">0åˆ†/å›</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>æœ€é•·è¨˜éŒ²</span>
                        <strong id="maxMinutes">0åˆ†</strong>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">ğŸ¯ æœˆé–“ç›®æ¨™é”æˆåº¦</h3>
                <div class="stat-number" id="monthlyRate">0%</div>
                <div class="stat-label">é”æˆç‡</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="monthlyProgress" style="width: 0%">
                        0/80 ã‚»ãƒƒã‚·ãƒ§ãƒ³
                    </div>
                </div>
                <p style="margin-top: 10px; color: #718096; font-size: 14px;" id="monthlyRemaining">
                    æ®‹ã‚Š: 80ã‚»ãƒƒã‚·ãƒ§ãƒ³
                </p>
            </div>

            <div class="card">
                <h3 class="card-title">âœ¨ åŠ¹æœæ¸¬å®šï¼ˆå¹³å‡å€¤ï¼‰</h3>
                <div class="effect-grid">
                    <div class="effect-item">
                        <div class="effect-score" id="stressScore">0.0</div>
                        <div class="effect-label">ã‚¹ãƒˆãƒ¬ã‚¹è»½æ¸›</div>
                    </div>
                    <div class="effect-item">
                        <div class="effect-score" id="focusScore">0.0</div>
                        <div class="effect-label">é›†ä¸­åŠ›å‘ä¸Š</div>
                    </div>
                    <div class="effect-item">
                        <div class="effect-score" id="sleepScore">0.0</div>
                        <div class="effect-label">ç¡çœ ã®è³ª</div>
                    </div>
                    <div class="effect-item">
                        <div class="effect-score" id="moodScore">0.0</div>
                        <div class="effect-label">æ°—åˆ†ã®å®‰å®š</div>
                    </div>
                </div>
            </div>

            <div class="card full-width">
                <h3 class="card-title">ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼åˆ¥é€²æ—</h3>
                <div id="teamMembersList">
                </div>
            </div>

            <div class="card full-width">
                <h3 class="card-title">ğŸ“ˆ é€±æ¬¡æ¨ç§»ã‚°ãƒ©ãƒ•</h3>
                <div class="chart-container">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>

            <div class="card full-width">
                <h3 class="card-title">ğŸ“Š åŠ¹æœæ¸¬å®šæ¨ç§»</h3>
                <div class="chart-container">
                    <canvas id="effectChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebaseè¨­å®š
        let firebaseConfig = null;
        let database = null;
        let isConnected = false;
        const FIREBASE_CONFIG_KEY = 'firebase_config';
        const DATA_PATH = 'mindfulness_dashboard';

        // é€±ã®ãƒ©ãƒ™ãƒ«ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
        function generateWeekLabels() {
            const today = new Date();
            const labels = [];
            
            for (let i = 0; i < 8; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + (i * 7));
                
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const weekNumber = getWeekNumber(date);
                
                labels.push(`${year}å¹´${month}æœˆç¬¬${weekNumber}é€±`);
            }
            
            return labels;
        }

        // é€±ç•ªå·ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        function getWeekNumber(date) {
            const firstDayOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
            const dayOfMonth = date.getDate();
            const firstDayWeekday = firstDayOfMonth.getDay();
            const weekNumber = Math.ceil((dayOfMonth + firstDayWeekday) / 7);
            return weekNumber;
        }

        // æ—¥ä»˜ã®è¡¨ç¤º
        function updateDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('ja-JP', options);
        }
        updateDate();

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿
        const defaultData = {
            members: {
                'é‡æ': { sessions: 0, minutes: 0, stressTotal: 0, focusTotal: 0, sleepTotal: 0, moodTotal: 0, dataCount: 0 },
                'å¯ºæ¾¤': { sessions: 0, minutes: 0, stressTotal: 0, focusTotal: 0, sleepTotal: 0, moodTotal: 0, dataCount: 0 },
                'ä¸‹å‡º': { sessions: 0, minutes: 0, stressTotal: 0, focusTotal: 0, sleepTotal: 0, moodTotal: 0, dataCount: 0 },
                'æ±éƒ·': { sessions: 0, minutes: 0, stressTotal: 0, focusTotal: 0, sleepTotal: 0, moodTotal: 0, dataCount: 0 },
                'æ —ç§‹': { sessions: 0, minutes: 0, stressTotal: 0, focusTotal: 0, sleepTotal: 0, moodTotal: 0, dataCount: 0 }
            },
            weeklyData: [0, 0, 0, 0, 0, 0, 0, 0],
            effectData: {
                stress: [0, 0, 0, 0, 0, 0, 0, 0],
                focus: [0, 0, 0, 0, 0, 0, 0, 0],
                sleep: [0, 0, 0, 0, 0, 0, 0, 0],
                mood: [0, 0, 0, 0, 0, 0, 0, 0]
            },
            currentWeek: 0
        };

        let dashboardData = JSON.parse(JSON.stringify(defaultData));

        // FirebaseåˆæœŸåŒ–
        function initFirebase() {
            const savedConfig = localStorage.getItem(FIREBASE_CONFIG_KEY);
            if (savedConfig) {
                try {
                    firebaseConfig = JSON.parse(savedConfig);
                    connectToFirebase();
                } catch (error) {
                    console.error('Firebaseè¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    updateConnectionStatus('disconnected', 'âŒ è¨­å®šã‚¨ãƒ©ãƒ¼');
                }
            } else {
                updateConnectionStatus('disconnected', 'âš™ï¸ æœªè¨­å®š');
            }
        }

        // Firebaseæ¥ç¶š
        function connectToFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                database = firebase.database();
                
                // æ¥ç¶šçŠ¶æ…‹ã®ç›£è¦–
                database.ref('.info/connected').on('value', (snapshot) => {
                    if (snapshot.val() === true) {
                        isConnected = true;
                        updateConnectionStatus('connected', 'âœ… æ¥ç¶šä¸­');
                        loadDataFromFirebase();
                    } else {
                        isConnected = false;
                        updateConnectionStatus('disconnected', 'âš ï¸ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³');
                    }
                });

                // ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›´ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ç›£è¦–
                database.ref(DATA_PATH).on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        dashboardData = snapshot.val();
                        updateDashboard();
                        updateCharts();
                        showNotification('ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ');
                    }
                });

            } catch (error) {
                console.error('Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
                updateConnectionStatus('disconnected', 'âŒ æ¥ç¶šå¤±æ•—');
                alert('Firebaseæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }

        // æ¥ç¶šçŠ¶æ…‹ã®æ›´æ–°
        function updateConnectionStatus(status, text) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = 'connection-status status-' + status;
            statusEl.textContent = text;
        }

        // Firebaseè¨­å®šã‚’ä¿å­˜
        function saveFirebaseConfig() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const authDomain = document.getElementById('authDomain').value.trim();
            const databaseURL = document.getElementById('databaseURL').value.trim();
            const projectId = document.getElementById('projectId').value.trim();

            if (!apiKey || !authDomain || !databaseURL || !projectId) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            firebaseConfig = {
                apiKey: apiKey,
                authDomain: authDomain,
                databaseURL: databaseURL,
                projectId: projectId
            };

            localStorage.setItem(FIREBASE_CONFIG_KEY, JSON.stringify(firebaseConfig));
            
            hideSetupPanel();
            connectToFirebase();
            showNotification('âœ… Firebaseè¨­å®šãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ');
        }

        // è¨­å®šãƒ‘ãƒãƒ«ã®è¡¨ç¤º/éè¡¨ç¤º
        function showSetupPanel() {
            document.getElementById('setupPanel').classList.remove('hidden');
            
            // æ—¢å­˜ã®è¨­å®šã‚’è¡¨ç¤º
            const savedConfig = localStorage.getItem(FIREBASE_CONFIG_KEY);
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                document.getElementById('apiKey').value = config.apiKey || '';
                document.getElementById('authDomain').value = config.authDomain || '';
                document.getElementById('databaseURL').value = config.databaseURL || '';
                document.getElementById('projectId').value = config.projectId || '';
            }
        }

        function hideSetupPanel() {
            document.getElementById('setupPanel').classList.add('hidden');
        }

        // Firebaseã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        function saveDataToFirebase() {
            if (!database || !isConnected) {
                console.log('Firebaseæœªæ¥ç¶šã®ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ã«ä¿å­˜');
                return;
            }

            database.ref(DATA_PATH).set(dashboardData)
                .then(() => {
                    console.log('Firebaseã«ä¿å­˜æˆåŠŸ');
                })
                .catch((error) => {
                    console.error('Firebaseä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    showNotification('âš ï¸ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                });
        }

        // Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        function loadDataFromFirebase() {
            if (!database) return;

            database.ref(DATA_PATH).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        dashboardData = snapshot.val();
                        updateDashboard();
                        updateCharts();
                    } else {
                        // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                        saveDataToFirebase();
                    }
                })
                .catch((error) => {
                    console.error('Firebaseãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                });
        }

        // é€šçŸ¥è¡¨ç¤º
        function showNotification(message) {
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½åŠ æ©Ÿèƒ½
        function addSession() {
            const member = document.getElementById('memberSelect').value;
            const minutes = parseInt(document.getElementById('sessionMinutes').value);
            const stress = parseInt(document.getElementById('stressLevel').value) || 0;
            const focus = parseInt(document.getElementById('focusLevel').value) || 0;
            const sleep = parseInt(document.getElementById('sleepLevel').value) || 0;
            const mood = parseInt(document.getElementById('moodLevel').value) || 0;

            if (!member || !minutes) {
                alert('ãƒ¡ãƒ³ãƒãƒ¼ã¨å®Ÿæ–½æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (dashboardData.members[member]) {
                dashboardData.members[member].sessions += 1;
                dashboardData.members[member].minutes += minutes;
                
                if (stress > 0) dashboardData.members[member].stressTotal += stress;
                if (focus > 0) dashboardData.members[member].focusTotal += focus;
                if (sleep > 0) dashboardData.members[member].sleepTotal += sleep;
                if (mood > 0) dashboardData.members[member].moodTotal += mood;
                
                if (stress > 0 || focus > 0 || sleep > 0 || mood > 0) {
                    dashboardData.members[member].dataCount += 1;
                }
            }

            dashboardData.weeklyData[dashboardData.currentWeek] += 1;
            updateEffectTotals();
            
            // Firebaseã«ä¿å­˜
            saveDataToFirebase();
            
            updateDashboard();
            updateCharts();
            
            showNotification(`âœ… ${member}ã•ã‚“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆ${minutes}åˆ†ï¼‰ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ`);
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('memberSelect').value = '';
            document.getElementById('sessionMinutes').value = '';
            document.getElementById('stressLevel').value = '';
            document.getElementById('focusLevel').value = '';
            document.getElementById('sleepLevel').value = '';
            document.getElementById('moodLevel').value = '';
        }

        // åŠ¹æœãƒ‡ãƒ¼ã‚¿ã®åˆè¨ˆå€¤ã‚’æ›´æ–°
        function updateEffectTotals() {
            let totalStress = 0, totalFocus = 0, totalSleep = 0, totalMood = 0;
            
            Object.values(dashboardData.members).forEach(member => {
                totalStress += member.stressTotal;
                totalFocus += member.focusTotal;
                totalSleep += member.sleepTotal;
                totalMood += member.moodTotal;
            });
            
            dashboardData.effectData.stress[dashboardData.currentWeek] = totalStress;
            dashboardData.effectData.focus[dashboardData.currentWeek] = totalFocus;
            dashboardData.effectData.sleep[dashboardData.currentWeek] = totalSleep;
            dashboardData.effectData.mood[dashboardData.currentWeek] = totalMood;
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
        function updateDashboard() {
            let totalSessions = 0, totalStress = 0, totalFocus = 0, totalSleep = 0, totalMood = 0, totalDataCount = 0;
            
            Object.values(dashboardData.members).forEach(member => {
                totalSessions += member.sessions;
                totalStress += member.stressTotal;
                totalFocus += member.focusTotal;
                totalSleep += member.sleepTotal;
                totalMood += member.moodTotal;
                totalDataCount += member.dataCount;
            });
            
            const weeklyRate = Math.round((totalSessions / 25) * 100);
            document.getElementById('weeklyRate').textContent = weeklyRate + '%';
            document.getElementById('weeklyProgress').style.width = weeklyRate + '%';
            document.getElementById('weeklyProgress').textContent = `${totalSessions}/25 ã‚»ãƒƒã‚·ãƒ§ãƒ³`;

            let totalMinutes = 0, maxMinutes = 0;
            Object.values(dashboardData.members).forEach(member => {
                totalMinutes += member.minutes;
                if (member.minutes > maxMinutes) maxMinutes = member.minutes;
            });
            document.getElementById('totalMinutes').textContent = totalMinutes;
            document.getElementById('avgMinutes').textContent = totalSessions > 0 ? Math.round(totalMinutes / totalSessions) + 'åˆ†/å›' : '0åˆ†/å›';
            document.getElementById('maxMinutes').textContent = maxMinutes + 'åˆ†';
            
            const monthlyGoal = 80;
            const monthlyRate = Math.min(Math.round((totalSessions / monthlyGoal) * 100), 100);
            const remainingSessions = Math.max(monthlyGoal - totalSessions, 0);
            
            document.getElementById('monthlyRate').textContent = monthlyRate + '%';
            document.getElementById('monthlyProgress').style.width = monthlyRate + '%';
            document.getElementById('monthlyProgress').textContent = `${totalSessions}/${monthlyGoal} ã‚»ãƒƒã‚·ãƒ§ãƒ³`;
            document.getElementById('monthlyRemaining').textContent = `æ®‹ã‚Š: ${remainingSessions}ã‚»ãƒƒã‚·ãƒ§ãƒ³`;
            
            if (totalDataCount > 0) {
                document.getElementById('stressScore').textContent = (totalStress / totalDataCount).toFixed(1);
                document.getElementById('focusScore').textContent = (totalFocus / totalDataCount).toFixed(1);
                document.getElementById('sleepScore').textContent = (totalSleep / totalDataCount).toFixed(1);
                document.getElementById('moodScore').textContent = (totalMood / totalDataCount).toFixed(1);
            } else {
                document.getElementById('stressScore').textContent = '0.0';
                document.getElementById('focusScore').textContent = '0.0';
                document.getElementById('sleepScore').textContent = '0.0';
                document.getElementById('moodScore').textContent = '0.0';
            }
            
            updateMemberDisplay();
        }
        
        // ãƒ¡ãƒ³ãƒãƒ¼åˆ¥é€²æ—ã®è¡¨ç¤ºã‚’æ›´æ–°
        function updateMemberDisplay() {
            const membersList = document.getElementById('teamMembersList');
            membersList.innerHTML = '';
            
            Object.entries(dashboardData.members).forEach(([name, data]) => {
                const progressPercent = Math.round((data.sessions / 5) * 100);
                const badge = progressPercent === 100 ? 
                    '<span class="badge badge-success">å„ªç§€</span>' : 
                    (progressPercent < 50 ? '<span class="badge badge-warning">è¦ã‚µãƒãƒ¼ãƒˆ</span>' : '');
                
                const memberDiv = document.createElement('div');
                memberDiv.className = 'team-member';
                memberDiv.innerHTML = `
                    <div class="member-avatar">${name.charAt(0)}</div>
                    <div class="member-info">
                        <div class="member-name">
                            ${name}
                            ${badge}
                        </div>
                        <div class="member-stats">ä»Šé€±: ${data.sessions}/5å› | åˆè¨ˆ: ${data.minutes}åˆ†</div>
                    </div>
                    <div class="member-progress">
                        <div class="member-progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                `;
                membersList.appendChild(memberDiv);
            });
        }

        // ã‚°ãƒ©ãƒ•æ›´æ–°é–¢æ•°
        function updateCharts() {
            const maxWeekly = Math.max(...dashboardData.weeklyData, 25);
            weeklyChart.options.scales.y.max = Math.ceil(maxWeekly / 5) * 5 + 5;
            weeklyChart.data.datasets[0].data = dashboardData.weeklyData;
            weeklyChart.update();
            
            const allEffectValues = [
                ...dashboardData.effectData.stress,
                ...dashboardData.effectData.focus,
                ...dashboardData.effectData.sleep,
                ...dashboardData.effectData.mood
            ];
            const maxEffect = Math.max(...allEffectValues, 50);
            effectChart.options.scales.y.max = Math.ceil(maxEffect / 10) * 10 + 10;
            
            effectChart.data.datasets[0].data = dashboardData.effectData.stress;
            effectChart.data.datasets[1].data = dashboardData.effectData.focus;
            effectChart.data.datasets[2].data = dashboardData.effectData.sleep;
            effectChart.data.datasets[3].data = dashboardData.effectData.mood;
            effectChart.update();
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function exportData() {
            const csvContent = "data:text/csv;charset=utf-8,ãƒ¡ãƒ³ãƒãƒ¼,ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°,åˆè¨ˆæ™‚é–“ï¼ˆåˆ†ï¼‰,ã‚¹ãƒˆãƒ¬ã‚¹åˆè¨ˆ,é›†ä¸­åŠ›åˆè¨ˆ,ç¡çœ åˆè¨ˆ,æ°—åˆ†åˆè¨ˆ\n" +
                Object.entries(dashboardData.members).map(([name, data]) => 
                    `${name},${data.sessions},${data.minutes},${data.stressTotal},${data.focusTotal},${data.sleepTotal},${data.moodTotal}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "mindfulness_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
        }

        // é€±æ¬¡ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½
        function resetWeek() {
            if (confirm('é€±æ¬¡ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ã¨æ™‚é–“ï¼‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nâ€»åŠ¹æœæ¸¬å®šãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã¾ã™\nâ€»ãƒãƒ¼ãƒ å…¨å“¡ã«å½±éŸ¿ã—ã¾ã™')) {
                Object.keys(dashboardData.members).forEach(member => {
                    dashboardData.members[member].sessions = 0;
                    dashboardData.members[member].minutes = 0;
                });
                
                saveDataToFirebase();
                updateDashboard();
                showNotification('ğŸ”„ é€±æ¬¡ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
            }
        }

        // é€±ã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
        const weekLabels = generateWeekLabels();

        // é€±æ¬¡æ¨ç§»ã‚°ãƒ©ãƒ•
        const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
        const weeklyChart = new Chart(weeklyCtx, {
            type: 'bar',
            data: {
                labels: weekLabels,
                datasets: [{
                    label: 'å®Ÿæ–½ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°',
                    data: dashboardData.weeklyData,
                    backgroundColor: 'rgba(102, 126, 234, 0.6)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 2,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        borderRadius: 8
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 30,
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    },
                    x: { grid: { display: false } }
                }
            }
        });

        // åŠ¹æœæ¸¬å®šæ¨ç§»ã‚°ãƒ©ãƒ•
        const effectCtx = document.getElementById('effectChart').getContext('2d');
        const effectChart = new Chart(effectCtx, {
            type: 'line',
            data: {
                labels: weekLabels,
                datasets: [
                    {
                        label: 'ã‚¹ãƒˆãƒ¬ã‚¹è»½æ¸›',
                        data: dashboardData.effectData.stress,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.4
                    },
                    {
                        label: 'é›†ä¸­åŠ›å‘ä¸Š',
                        data: dashboardData.effectData.focus,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.4
                    },
                    {
                        label: 'ç¡çœ ã®è³ª',
                        data: dashboardData.effectData.sleep,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.4
                    },
                    {
                        label: 'æ°—åˆ†ã®å®‰å®š',
                        data: dashboardData.effectData.mood,
                        borderColor: 'rgba(153, 102, 255, 1)',
                        backgroundColor: 'rgba(153, 102, 255, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 15, font: { size: 12 } }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        borderRadius: 8
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    },
                    x: { grid: { display: false } }
                }
            }
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.onload = function() {
            initFirebase();
            updateDashboard();
            updateCharts();
        };
    </script>
</body>
</html>