<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒã‚¹ç‘æƒ³ é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h1 {
            color: #5a67d8;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .zen-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .video-link-section {
            display: flex;
            align-items: center;
            gap: 25px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 25px 30px;
            border-radius: 18px;
            border: 3px solid rgba(102, 126, 234, 0.4);
        }

        .mindfulness-image-link {
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25);
            flex-shrink: 0;
        }

        .mindfulness-image-link:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.35);
        }

        .mindfulness-image {
            width: 200px;
            height: auto;
            display: block;
            border-radius: 15px;
        }

        .video-description {
            flex: 1;
        }

        .video-description-title {
            font-size: 22px;
            font-weight: bold;
            color: #5a67d8;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .video-description-text {
            font-size: 17px;
            color: #4a5568;
            line-height: 1.7;
        }

        .date-info {
            color: #666;
            font-size: 14px;
        }

        .save-status {
            display: inline-block;
            margin-left: 10px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            background: #c6f6d5;
            color: #22543d;
            font-weight: bold;
        }

        .audio-player-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .audio-controls label {
            font-weight: 600;
            color: #4a5568;
        }

        .audio-controls input[type="range"] {
            flex: 1;
            min-width: 200px;
            height: 8px;
            background: #e2e8f0;
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
        }

        .audio-controls input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            cursor: pointer;
            border-radius: 50%;
        }

        .audio-controls input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }

        .time-display {
            font-size: 24px;
            font-weight: bold;
            color: #5a67d8;
            min-width: 80px;
            text-align: center;
        }

        .audio-button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s ease;
            font-size: 16px;
        }

        .audio-button:hover {
            opacity: 0.9;
        }

        .audio-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .audio-button.stop {
            background: linear-gradient(135deg, #fc8181, #f56565);
        }

        .audio-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            color: #4a5568;
            font-size: 14px;
        }

        .audio-progress {
            flex: 1;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .audio-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78, #38a169);
            width: 0%;
            transition: width 0.3s ease;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            font-size: 18px;
            color: #4a5568;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .stat-number {
            font-size: 48px;
            font-weight: bold;
            color: #5a67d8;
            margin: 10px 0;
        }

        .stat-label {
            color: #718096;
            font-size: 14px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e2e8f0;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .team-member {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: #f7fafc;
            border-radius: 10px;
            transition: background 0.3s ease;
        }

        .team-member:hover {
            background: #edf2f7;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 600;
            color: #2d3748;
        }

        .member-stats {
            font-size: 12px;
            color: #718096;
        }

        .member-progress {
            width: 100px;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .member-progress-fill {
            height: 100%;
            background: #48bb78;
            transition: width 0.3s ease;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .effect-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .effect-item {
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            text-align: center;
        }

        .effect-score {
            font-size: 24px;
            font-weight: bold;
            color: #5a67d8;
            margin-bottom: 5px;
        }

        .effect-label {
            font-size: 12px;
            color: #718096;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        button:hover {
            opacity: 0.9;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        input, select {
            padding: 8px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 14px;
            min-width: 180px;
        }

        select {
            min-width: 150px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }

        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-warning {
            background: #fed7d7;
            color: #742a2a;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .config-notice {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }

        .config-notice strong {
            display: block;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .effect-grid {
                grid-template-columns: 1fr;
            }

            input, select {
                min-width: 100%;
            }

            .header-top {
                flex-direction: column;
                align-items: flex-start;
            }

            .video-link-section {
                width: 100%;
                padding: 20px;
            }

            .mindfulness-image {
                width: 140px;
            }

            .video-description-title {
                font-size: 18px;
            }

            .video-description-text {
                font-size: 15px;
            }

            .audio-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .audio-controls input[type="range"] {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <header>
            <div class="header-top">
                <div class="header-title">
                    <h1>
                        <div class="zen-icon">ğŸ§˜</div>
                        ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒã‚¹ç‘æƒ³ é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                    </h1>
                </div>
                <div class="video-link-section">
                    <a href="https://youtu.be/f5i0AKJWMck" target="_blank" class="mindfulness-image-link" title="ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒã‚¹ç‘æƒ³å‹•ç”»ã‚’è¦‹ã‚‹">
                        <img src="mindfulness.png" alt="ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒã‚¹ç‘æƒ³" class="mindfulness-image">
                    </a>
                    <div class="video-description">
                        <div class="video-description-title">
                            ğŸ“ åˆå¿ƒè€…å‘ã‘è§£èª¬å‹•ç”»
                        </div>
                        <div class="video-description-text">
                            ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒã‚¹ç‘æƒ³ã®åŸºæœ¬ã‚’<br>
                            ã‚ã‹ã‚Šã‚„ã™ãå­¦ã¹ã‚‹å‹•ç”»ã§ã™
                        </div>
                    </div>
                </div>
            </div>
            <div class="date-info">
                <span id="currentDate"></span> | æ¥­å‹™æ”¹å–„ãƒãƒ¼ãƒ 
                <span class="save-status" id="saveStatus">ğŸ”„ èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
        </header>

        <!-- éŸ³å£°å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="audio-player-section">
            <h3 style="margin-bottom: 15px; color: #4a5568;">ğŸµ ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒã‚¹éŸ³å£°ã‚¬ã‚¤ãƒ‰</h3>
            <div class="audio-controls">
                <label for="audioDuration">å†ç”Ÿæ™‚é–“:</label>
                <input type="range" id="audioDuration" min="1" max="10" value="5" step="1">
                <div class="time-display" id="timeDisplay">5åˆ†</div>
                <button class="audio-button" id="playButton" onclick="playAudio()">â–¶ å†ç”Ÿ</button>
                <button class="audio-button stop" id="stopButton" onclick="stopAudio()" style="display: none;">â¹ åœæ­¢</button>
            </div>
            <div class="audio-status" id="audioStatus" style="display: none;">
                <span id="currentTime">0:00</span>
                <div class="audio-progress">
                    <div class="audio-progress-fill" id="audioProgressFill"></div>
                </div>
                <span id="remainingTime">5:00</span>
            </div>
            <audio id="audioPlayer" src="mindfulness.mp3" style="display: none;"></audio>
        </div>

        <!-- APIè¨­å®šã®æ³¨æ„å–šèµ· -->
        <div class="config-notice" id="configNotice" style="display: none;">
            <strong>âš ï¸ è¨­å®šãŒå¿…è¦ã§ã™</strong>
            HTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ã€ŒAPI_URLã€ã«Google Apps Scriptã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
        </div>

        <div class="control-panel">
            <h3 style="margin-bottom: 15px; color: #4a5568;">ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ãƒ»ç®¡ç†</h3>
            <div class="input-group">
                <select id="memberSelect">
                    <option value="">ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠ</option>
                    <option value="é‡æ">é‡æ</option>
                    <option value="å¯ºæ¾¤">å¯ºæ¾¤</option>
                    <option value="ä¸‹å‡º">ä¸‹å‡º</option>
                    <option value="æ±éƒ·">æ±éƒ·</option>
                    <option value="æ —ç§‹">æ —ç§‹</option>
                </select>
                <input type="number" id="sessionMinutes" placeholder="å®Ÿæ–½æ™‚é–“ï¼ˆåˆ†ï¼‰" min="1" max="60">
            </div>
            <div class="input-group">
                <input type="number" id="stressLevel" placeholder="ã‚¹ãƒˆãƒ¬ã‚¹è»½æ¸›åº¦(1-10)" min="1" max="10">
                <input type="number" id="focusLevel" placeholder="é›†ä¸­åŠ›å‘ä¸Šåº¦(1-10)" min="1" max="10">
                <input type="number" id="sleepLevel" placeholder="ç¡çœ ã®è³ª(1-10)" min="1" max="10">
                <input type="number" id="moodLevel" placeholder="æ°—åˆ†ã®å®‰å®š(1-10)" min="1" max="10">
            </div>
            <div class="button-group">
                <button onclick="addSession()" id="addButton">ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²</button>
                <button onclick="loadDataFromSheet()">ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿</button>
                <button onclick="exportData()">ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h3 class="card-title">ğŸ“Š ä»Šé€±ã®å®Ÿæ–½çŠ¶æ³</h3>
                <div class="stat-number" id="weeklyRate">0%</div>
                <div class="stat-label">ãƒãƒ¼ãƒ å…¨ä½“ã®å®Ÿæ–½ç‡</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="weeklyProgress" style="width: 0%">
                        0/25 ã‚»ãƒƒã‚·ãƒ§ãƒ³
                    </div>
                </div>
                <p style="margin-top: 10px; color: #718096; font-size: 14px;">
                    ç›®æ¨™: é€±5æ—¥ Ã— 5äºº = 25ã‚»ãƒƒã‚·ãƒ§ãƒ³
                </p>
            </div>

            <div class="card">
                <h3 class="card-title">â±ï¸ ç´¯è¨ˆå®Ÿæ–½æ™‚é–“</h3>
                <div class="stat-number" id="totalMinutes">0</div>
                <div class="stat-label">åˆ†ï¼ˆä»Šé€±ï¼‰</div>
                <div style="margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>å¹³å‡å®Ÿæ–½æ™‚é–“</span>
                        <strong id="avgMinutes">0åˆ†/å›</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>æœ€é•·è¨˜éŒ²</span>
                        <strong id="maxMinutes">0åˆ†</strong>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">ğŸ¯ æœˆé–“ç›®æ¨™é”æˆåº¦</h3>
                <div class="stat-number" id="monthlyRate">0%</div>
                <div class="stat-label">é”æˆç‡</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="monthlyProgress" style="width: 0%">
                        0/80 ã‚»ãƒƒã‚·ãƒ§ãƒ³
                    </div>
                </div>
                <p style="margin-top: 10px; color: #718096; font-size: 14px;" id="monthlyRemaining">
                    æ®‹ã‚Š: 80ã‚»ãƒƒã‚·ãƒ§ãƒ³
                </p>
            </div>

            <div class="card">
                <h3 class="card-title">âœ¨ åŠ¹æœæ¸¬å®šï¼ˆå¹³å‡å€¤ï¼‰</h3>
                <div class="effect-grid">
                    <div class="effect-item">
                        <div class="effect-score" id="stressScore">0.0</div>
                        <div class="effect-label">ã‚¹ãƒˆãƒ¬ã‚¹è»½æ¸›</div>
                    </div>
                    <div class="effect-item">
                        <div class="effect-score" id="focusScore">0.0</div>
                        <div class="effect-label">é›†ä¸­åŠ›å‘ä¸Š</div>
                    </div>
                    <div class="effect-item">
                        <div class="effect-score" id="sleepScore">0.0</div>
                        <div class="effect-label">ç¡çœ ã®è³ª</div>
                    </div>
                    <div class="effect-item">
                        <div class="effect-score" id="moodScore">0.0</div>
                        <div class="effect-label">æ°—åˆ†ã®å®‰å®š</div>
                    </div>
                </div>
            </div>

            <div class="card full-width">
                <h3 class="card-title">ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼åˆ¥é€²æ—</h3>
                <div id="teamMembersList">
                </div>
            </div>

            <div class="card full-width">
                <h3 class="card-title">ğŸ“ˆ é€±æ¬¡æ¨ç§»ã‚°ãƒ©ãƒ•</h3>
                <div class="chart-container">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>

            <div class="card full-width">
                <h3 class="card-title">ğŸ“Š åŠ¹æœæ¸¬å®šæ¨ç§»</h3>
                <div class="chart-container">
                    <canvas id="effectChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===================================
        // ğŸ”§ é‡è¦: ã“ã“ã«Google Apps Scriptã®ãƒ‡ãƒ—ãƒ­ã‚¤URLã‚’è¨­å®šã—ã¦ãã ã•ã„
        // ===================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbzyzHaM58wnyhB8iQb9Qiguulh4GqW32vQW8xvUsf8R6I_rXd9QhHJNOQrFpLQXByGCMw/exec';
        // ä¾‹: 'https://script.google.com/macros/s/AKfycbx.../exec'
        
        // API URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
            document.getElementById('configNotice').style.display = 'block';
        }

        // ===================================
        // éŸ³å£°å†ç”Ÿæ©Ÿèƒ½
        // ===================================
        const audioPlayer = document.getElementById('audioPlayer');
        const audioDuration = document.getElementById('audioDuration');
        const timeDisplay = document.getElementById('timeDisplay');
        const playButton = document.getElementById('playButton');
        const stopButton = document.getElementById('stopButton');
        const audioStatus = document.getElementById('audioStatus');
        const audioProgressFill = document.getElementById('audioProgressFill');
        const currentTimeDisplay = document.getElementById('currentTime');
        const remainingTimeDisplay = document.getElementById('remainingTime');

        let audioTimer = null;
        let selectedDuration = 5; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5åˆ†

        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã®å‡¦ç†
        audioDuration.addEventListener('input', function() {
            selectedDuration = parseInt(this.value);
            timeDisplay.textContent = selectedDuration + 'åˆ†';
            updateRemainingTime();
        });

        // éŸ³å£°å†ç”Ÿ
        function playAudio() {
            selectedDuration = parseInt(audioDuration.value);
            const durationInSeconds = selectedDuration * 60;

            audioPlayer.currentTime = 0;
            audioPlayer.play();

            playButton.style.display = 'none';
            stopButton.style.display = 'inline-block';
            audioStatus.style.display = 'flex';

            // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚»ãƒƒãƒˆ
            audioTimer = setTimeout(() => {
                stopAudio();
            }, durationInSeconds * 1000);

            // é€²æ—æ›´æ–°
            updateAudioProgress();
        }

        // éŸ³å£°åœæ­¢
        function stopAudio() {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;

            if (audioTimer) {
                clearTimeout(audioTimer);
                audioTimer = null;
            }

            playButton.style.display = 'inline-block';
            stopButton.style.display = 'none';
            audioStatus.style.display = 'none';
            audioProgressFill.style.width = '0%';
        }

        // é€²æ—ãƒãƒ¼ã®æ›´æ–°
        function updateAudioProgress() {
            if (!audioPlayer.paused) {
                const currentTime = audioPlayer.currentTime;
                const maxDuration = selectedDuration * 60;
                const progress = (currentTime / maxDuration) * 100;

                audioProgressFill.style.width = Math.min(progress, 100) + '%';

                // æ™‚é–“è¡¨ç¤ºã®æ›´æ–°
                const minutes = Math.floor(currentTime / 60);
                const seconds = Math.floor(currentTime % 60);
                currentTimeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                const remaining = maxDuration - currentTime;
                const remainingMinutes = Math.floor(remaining / 60);
                const remainingSeconds = Math.floor(remaining % 60);
                remainingTimeDisplay.textContent = `${remainingMinutes}:${remainingSeconds.toString().padStart(2, '0')}`;

                requestAnimationFrame(updateAudioProgress);
            }
        }

        // æ®‹ã‚Šæ™‚é–“ã®åˆæœŸè¡¨ç¤ºæ›´æ–°
        function updateRemainingTime() {
            const minutes = selectedDuration;
            remainingTimeDisplay.textContent = `${minutes}:00`;
        }

        // éŸ³å£°ãŒçµ‚äº†ã—ãŸã¨ãã®å‡¦ç†
        audioPlayer.addEventListener('ended', function() {
            if (!audioTimer) {
                // ã‚¿ã‚¤ãƒãƒ¼ã§åœæ­¢ã—ã¦ã„ãªã„å ´åˆï¼ˆéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒçµ‚äº†ã—ãŸå ´åˆï¼‰
                stopAudio();
            }
        });

        // ===================================
        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ©Ÿèƒ½
        // ===================================

        // æ—¥ä»˜ã®è¡¨ç¤º
        function updateDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('ja-JP', options);
        }
        updateDate();

        // æ—¥æ›œæ—¥ã‚’é€±ã®é–‹å§‹æ—¥ã¨ã—ã¦é€±ç•ªå·ã‚’å–å¾—ï¼ˆ0ã‹ã‚‰å§‹ã¾ã‚‹ï¼‰
        // 2024å¹´12æœˆ1æ—¥ï¼ˆæ—¥æ›œæ—¥ï¼‰ã‚’é€±0ã¨ã—ã¦è¨ˆç®—
        function getCurrentWeekNumber() {
            const today = new Date();
            const startDate = new Date(2024, 11, 1); // 2024å¹´12æœˆ1æ—¥ï¼ˆæ—¥æ›œæ—¥ï¼‰
            
            // ãã®é€±ã®æ—¥æ›œæ—¥ã‚’å–å¾—ã™ã‚‹é–¢æ•°
            function getSunday(date) {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day; // æ—¥æ›œæ—¥ã¾ã§ã®æ—¥æ•°å·®
                return new Date(d.setDate(diff));
            }
            
            const startSunday = getSunday(startDate);
            const todaySunday = getSunday(today);
            
            // æ—¥æ›œæ—¥ã‹ã‚‰æ—¥æ›œæ—¥ã¾ã§ã®é€±æ•°ã‚’è¨ˆç®—
            const diffTime = todaySunday - startSunday;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const weekNumber = Math.floor(diffDays / 7);
            
            return weekNumber;
        }

        // é€±ã®ãƒ©ãƒ™ãƒ«ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ï¼ˆæ—¥æ›œå§‹ã¾ã‚Šã®é€±ï¼‰
        function generateWeekLabels() {
            const labels = [];
            const today = new Date();
            const currentWeekIndex = getCurrentWeekNumber();
            
            // ãã®é€±ã®æ—¥æ›œæ—¥ã‚’å–å¾—ã™ã‚‹é–¢æ•°
            function getSunday(date) {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day;
                return new Date(d.setDate(diff));
            }
            
            // ç¾åœ¨ã®é€±ã®æ—¥æ›œæ—¥ã‚’è¦‹ã¤ã‘ã‚‹
            const currentSunday = getSunday(today);
            
            // 4é€±å‰ã‹ã‚‰3é€±å¾Œã¾ã§ï¼ˆè¨ˆ8é€±é–“ï¼‰ã®ãƒ©ãƒ™ãƒ«ã‚’ç”Ÿæˆ
            for (let i = -4; i <= 3; i++) {
                const weekStart = new Date(currentSunday);
                weekStart.setDate(currentSunday.getDate() + (i * 7));
                
                const year = weekStart.getFullYear();
                const month = weekStart.getMonth() + 1;
                const day = weekStart.getDate();
                
                // é€±ã®çµ‚ã‚ã‚Šï¼ˆåœŸæ›œæ—¥ï¼‰ã‚’è¨ˆç®—
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                const endMonth = weekEnd.getMonth() + 1;
                const endDay = weekEnd.getDate();
                
                labels.push(`${month}/${day}ã€œ${endMonth}/${endDay}`);
            }
            
            return labels;
        }

        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”¨ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        let dashboardData = {
            members: {
                'é‡æ': { sessions: 0, minutes: 0, stressTotal: 0, focusTotal: 0, sleepTotal: 0, moodTotal: 0 },
                'å¯ºæ¾¤': { sessions: 0, minutes: 0, stressTotal: 0, focusTotal: 0, sleepTotal: 0, moodTotal: 0 },
                'ä¸‹å‡º': { sessions: 0, minutes: 0, stressTotal: 0, focusTotal: 0, sleepTotal: 0, moodTotal: 0 },
                'æ±éƒ·': { sessions: 0, minutes: 0, stressTotal: 0, focusTotal: 0, sleepTotal: 0, moodTotal: 0 },
                'æ —ç§‹': { sessions: 0, minutes: 0, stressTotal: 0, focusTotal: 0, sleepTotal: 0, moodTotal: 0 }
            },
            weeklyData: [0, 0, 0, 0, 0, 0, 0, 0],
            effectData: {
                stress: [0, 0, 0, 0, 0, 0, 0, 0],
                focus: [0, 0, 0, 0, 0, 0, 0, 0],
                sleep: [0, 0, 0, 0, 0, 0, 0, 0],
                mood: [0, 0, 0, 0, 0, 0, 0, 0]
            },
            currentWeek: getCurrentWeekNumber()
        };

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }

        // ä¿å­˜çŠ¶æ…‹ã®è¡¨ç¤º
        function showSaveStatus(text, bgColor, textColor) {
            const status = document.getElementById('saveStatus');
            status.textContent = text;
            status.style.background = bgColor;
            status.style.color = textColor;
        }

        // Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆJSONPæ–¹å¼ã§CORSå›é¿ï¼‰
        function loadDataFromSheet() {
            if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                alert('âš ï¸ Google Apps Scriptã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nHTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ã€ŒAPI_URLã€ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            showLoading(true);
            showSaveStatus('ğŸ”„ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...', '#bee3f8', '#2c5282');

            // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°åã‚’ç”Ÿæˆ
            const callbackName = 'jsonpCallback_' + Date.now();
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®šç¾©
            window[callbackName] = function(result) {
                try {
                    if (result.success) {
                        // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                        dashboardData.members = result.members;
                        dashboardData.weeklyData = result.weeklyData;
                        dashboardData.effectData = result.effectData;

                        // UIã‚’æ›´æ–°
                        updateDashboard();
                        updateCharts();

                        showSaveStatus('âœ… ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†', '#c6f6d5', '#22543d');
                    } else {
                        throw new Error(result.error || 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } catch (error) {
                    console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    showSaveStatus('âš ï¸ èª­ã¿è¾¼ã¿å¤±æ•—', '#fed7d7', '#742a2a');
                    alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nè©³ç´°: ' + error.message);
                } finally {
                    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    delete window[callbackName];
                    document.body.removeChild(script);
                    showLoading(false);
                }
            };

            // scriptã‚¿ã‚°ã‚’å‹•çš„ã«ä½œæˆã—ã¦JSONPãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            const script = document.createElement('script');
            script.src = `${API_URL}?action=getData&callback=${callbackName}`;
            script.onerror = function() {
                showSaveStatus('âš ï¸ èª­ã¿è¾¼ã¿å¤±æ•—', '#fed7d7', '#742a2a');
                alert('ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nURLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                delete window[callbackName];
                showLoading(false);
            };
            document.body.appendChild(script);
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½åŠ æ©Ÿèƒ½ï¼ˆJSONPæ–¹å¼ã§CORSå›é¿ï¼‰
        function addSession() {
            const member = document.getElementById('memberSelect').value;
            const minutes = parseInt(document.getElementById('sessionMinutes').value);
            const stress = parseInt(document.getElementById('stressLevel').value) || 0;
            const focus = parseInt(document.getElementById('focusLevel').value) || 0;
            const sleep = parseInt(document.getElementById('sleepLevel').value) || 0;
            const mood = parseInt(document.getElementById('moodLevel').value) || 0;

            if (!member || !minutes) {
                alert('ãƒ¡ãƒ³ãƒãƒ¼ã¨å®Ÿæ–½æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE') {
                alert('âš ï¸ Google Apps Scriptã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nHTMLãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ã€ŒAPI_URLã€ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const addButton = document.getElementById('addButton');
            addButton.disabled = true;
            addButton.textContent = 'ä¿å­˜ä¸­...';

            showLoading(true);
            showSaveStatus('ğŸ’¾ ä¿å­˜ä¸­...', '#bee3f8', '#2c5282');

            // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°åã‚’ç”Ÿæˆ
            const callbackName = 'jsonpCallback_' + Date.now();
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®šç¾©
            window[callbackName] = function(result) {
                try {
                    if (result.success) {
                        showSaveStatus('âœ… ä¿å­˜å®Œäº†', '#c6f6d5', '#22543d');
                        
                        // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                        setTimeout(() => {
                            loadDataFromSheet();
                        }, 500);
                        
                        alert(`${member}ã•ã‚“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆ${minutes}åˆ†ï¼‰ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ`);
                        
                        // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                        document.getElementById('memberSelect').value = '';
                        document.getElementById('sessionMinutes').value = '';
                        document.getElementById('stressLevel').value = '';
                        document.getElementById('focusLevel').value = '';
                        document.getElementById('sleepLevel').value = '';
                        document.getElementById('moodLevel').value = '';
                    } else {
                        throw new Error(result.error || 'ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } catch (error) {
                    console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    showSaveStatus('âš ï¸ ä¿å­˜å¤±æ•—', '#fed7d7', '#742a2a');
                    alert('ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nè©³ç´°: ' + error.message);
                } finally {
                    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    delete window[callbackName];
                    document.body.removeChild(script);
                    showLoading(false);
                    addButton.disabled = false;
                    addButton.textContent = 'ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²';
                }
            };

            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰ï¼ˆé€±ç•ªå·ã¯é€ã‚‰ãªã„ã€‚GASå´ã§è¨ˆç®—ï¼‰
            const params = new URLSearchParams({
                action: 'addSession',
                member: member,
                minutes: minutes,
                stress: stress,
                focus: focus,
                sleep: sleep,
                mood: mood,
                callback: callbackName
            });

            // scriptã‚¿ã‚°ã‚’å‹•çš„ã«ä½œæˆã—ã¦JSONPãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            const script = document.createElement('script');
            script.src = `${API_URL}?${params.toString()}`;
            script.onerror = function() {
                showSaveStatus('âš ï¸ ä¿å­˜å¤±æ•—', '#fed7d7', '#742a2a');
                alert('ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nURLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                delete window[callbackName];
                showLoading(false);
                addButton.disabled = false;
                addButton.textContent = 'ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨˜éŒ²';
            };
            document.body.appendChild(script);
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
        function updateDashboard() {
            // é€±æ¬¡å®Ÿæ–½ç‡ã®æ›´æ–°
            let totalSessions = 0;
            let totalStress = 0;
            let totalFocus = 0;
            let totalSleep = 0;
            let totalMood = 0;
            let dataCount = 0;
            
            Object.values(dashboardData.members).forEach(member => {
                totalSessions += member.sessions;
                totalStress += member.stressTotal;
                totalFocus += member.focusTotal;
                totalSleep += member.sleepTotal;
                totalMood += member.moodTotal;
                
                // ãƒ‡ãƒ¼ã‚¿æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆåˆè¨ˆå€¤ãŒ0ã‚ˆã‚Šå¤§ãã„å ´åˆï¼‰
                if (member.stressTotal > 0 || member.focusTotal > 0 || 
                    member.sleepTotal > 0 || member.moodTotal > 0) {
                    dataCount += member.sessions;
                }
            });
            
            const weeklyRate = Math.round((totalSessions / 25) * 100);
            document.getElementById('weeklyRate').textContent = weeklyRate + '%';
            document.getElementById('weeklyProgress').style.width = weeklyRate + '%';
            document.getElementById('weeklyProgress').textContent = `${totalSessions}/25 ã‚»ãƒƒã‚·ãƒ§ãƒ³`;

            // ç´¯è¨ˆæ™‚é–“ã®æ›´æ–°
            let totalMinutes = 0;
            let maxMinutes = 0;
            Object.values(dashboardData.members).forEach(member => {
                totalMinutes += member.minutes;
                if (member.minutes > maxMinutes) {
                    maxMinutes = member.minutes;
                }
            });
            document.getElementById('totalMinutes').textContent = totalMinutes;
            if (totalSessions > 0) {
                document.getElementById('avgMinutes').textContent = Math.round(totalMinutes / totalSessions) + 'åˆ†/å›';
            } else {
                document.getElementById('avgMinutes').textContent = '0åˆ†/å›';
            }
            document.getElementById('maxMinutes').textContent = maxMinutes + 'åˆ†';
            
            // æœˆé–“é”æˆåº¦ã®æ›´æ–°
            const monthlyGoal = 80;
            const monthlyRate = Math.min(Math.round((totalSessions / monthlyGoal) * 100), 100);
            const remainingSessions = Math.max(monthlyGoal - totalSessions, 0);
            
            document.getElementById('monthlyRate').textContent = monthlyRate + '%';
            document.getElementById('monthlyProgress').style.width = monthlyRate + '%';
            document.getElementById('monthlyProgress').textContent = `${totalSessions}/${monthlyGoal} ã‚»ãƒƒã‚·ãƒ§ãƒ³`;
            document.getElementById('monthlyRemaining').textContent = `æ®‹ã‚Š: ${remainingSessions}ã‚»ãƒƒã‚·ãƒ§ãƒ³`;
            
            // åŠ¹æœæ¸¬å®šã®å¹³å‡å€¤ã‚’æ›´æ–°
            if (dataCount > 0) {
                document.getElementById('stressScore').textContent = (totalStress / dataCount).toFixed(1);
                document.getElementById('focusScore').textContent = (totalFocus / dataCount).toFixed(1);
                document.getElementById('sleepScore').textContent = (totalSleep / dataCount).toFixed(1);
                document.getElementById('moodScore').textContent = (totalMood / dataCount).toFixed(1);
            } else {
                document.getElementById('stressScore').textContent = '0.0';
                document.getElementById('focusScore').textContent = '0.0';
                document.getElementById('sleepScore').textContent = '0.0';
                document.getElementById('moodScore').textContent = '0.0';
            }
            
            // ãƒ¡ãƒ³ãƒãƒ¼åˆ¥é€²æ—UIã‚’æ›´æ–°
            updateMemberDisplay();
        }
        
        // ãƒ¡ãƒ³ãƒãƒ¼åˆ¥é€²æ—ã®è¡¨ç¤ºã‚’æ›´æ–°
        function updateMemberDisplay() {
            const membersList = document.getElementById('teamMembersList');
            membersList.innerHTML = '';
            
            Object.entries(dashboardData.members).forEach(([name, data]) => {
                const progressPercent = Math.round((data.sessions / 5) * 100);
                const badge = progressPercent >= 100 ? 
                    '<span class="badge badge-success">å„ªç§€</span>' : 
                    (progressPercent < 50 ? '<span class="badge badge-warning">è¦ã‚µãƒãƒ¼ãƒˆ</span>' : '');
                
                const memberDiv = document.createElement('div');
                memberDiv.className = 'team-member';
                memberDiv.innerHTML = `
                    <div class="member-avatar">${name.charAt(0)}</div>
                    <div class="member-info">
                        <div class="member-name">
                            ${name}
                            ${badge}
                        </div>
                        <div class="member-stats">ä»Šé€±: ${data.sessions}/5å› | åˆè¨ˆ: ${data.minutes}åˆ†</div>
                    </div>
                    <div class="member-progress">
                        <div class="member-progress-fill" style="width: ${Math.min(progressPercent, 100)}%"></div>
                    </div>
                `;
                membersList.appendChild(memberDiv);
            });
        }

        // ã‚°ãƒ©ãƒ•æ›´æ–°é–¢æ•°
        function updateCharts() {
            // é€±æ¬¡æ¨ç§»ã‚°ãƒ©ãƒ•ã®æœ€å¤§å€¤ã‚’è‡ªå‹•è¨ˆç®—
            const maxWeekly = Math.max(...dashboardData.weeklyData, 25);
            weeklyChart.options.scales.y.max = Math.ceil(maxWeekly / 5) * 5 + 5;
            weeklyChart.data.datasets[0].data = dashboardData.weeklyData;
            weeklyChart.update();
            
            // åŠ¹æœæ¸¬å®šã‚°ãƒ©ãƒ•ã®æœ€å¤§å€¤ã‚’è‡ªå‹•è¨ˆç®—
            const allEffectValues = [
                ...dashboardData.effectData.stress,
                ...dashboardData.effectData.focus,
                ...dashboardData.effectData.sleep,
                ...dashboardData.effectData.mood
            ];
            const maxEffect = Math.max(...allEffectValues, 50);
            effectChart.options.scales.y.max = Math.ceil(maxEffect / 10) * 10 + 10;
            
            effectChart.data.datasets[0].data = dashboardData.effectData.stress;
            effectChart.data.datasets[1].data = dashboardData.effectData.focus;
            effectChart.data.datasets[2].data = dashboardData.effectData.sleep;
            effectChart.data.datasets[3].data = dashboardData.effectData.mood;
            effectChart.update();
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        function exportData() {
            const csvContent = "data:text/csv;charset=utf-8,ãƒ¡ãƒ³ãƒãƒ¼,ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°,åˆè¨ˆæ™‚é–“ï¼ˆåˆ†ï¼‰,ã‚¹ãƒˆãƒ¬ã‚¹åˆè¨ˆ,é›†ä¸­åŠ›åˆè¨ˆ,ç¡çœ åˆè¨ˆ,æ°—åˆ†åˆè¨ˆ\n" +
                Object.entries(dashboardData.members).map(([name, data]) => 
                    `${name},${data.sessions},${data.minutes},${data.stressTotal},${data.focusTotal},${data.sleepTotal},${data.moodTotal}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `mindfulness_data_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
        }

        // é€±ã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
        const weekLabels = generateWeekLabels();

        // é€±æ¬¡æ¨ç§»ã‚°ãƒ©ãƒ•
        const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
        const weeklyChart = new Chart(weeklyCtx, {
            type: 'bar',
            data: {
                labels: weekLabels,
                datasets: [{
                    label: 'å®Ÿæ–½ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°',
                    data: dashboardData.weeklyData,
                    backgroundColor: 'rgba(102, 126, 234, 0.6)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 2,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        borderRadius: 8
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 30,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // åŠ¹æœæ¸¬å®šæ¨ç§»ã‚°ãƒ©ãƒ•
        const effectCtx = document.getElementById('effectChart').getContext('2d');
        const effectChart = new Chart(effectCtx, {
            type: 'line',
            data: {
                labels: weekLabels,
                datasets: [
                    {
                        label: 'ã‚¹ãƒˆãƒ¬ã‚¹è»½æ¸›',
                        data: dashboardData.effectData.stress,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.4
                    },
                    {
                        label: 'é›†ä¸­åŠ›å‘ä¸Š',
                        data: dashboardData.effectData.focus,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.4
                    },
                    {
                        label: 'ç¡çœ ã®è³ª',
                        data: dashboardData.effectData.sleep,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.4
                    },
                    {
                        label: 'æ°—åˆ†ã®å®‰å®š',
                        data: dashboardData.effectData.mood,
                        borderColor: 'rgba(153, 102, 255, 1)',
                        backgroundColor: 'rgba(153, 102, 255, 0.1)',
                        borderWidth: 3,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        borderRadius: 8
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.onload = function() {
            updateDashboard();
            updateCharts();
            
            // åˆå›ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadDataFromSheet();
        };
    </script>
</body>
</html>